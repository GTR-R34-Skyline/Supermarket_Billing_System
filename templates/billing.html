{% extends "base.html" %}
{% block content %}
<h2>Billing</h2>

<form method="POST" action="{{ url_for('billing') }}" id="billing-form">
    <div>
        <label for="customer_id">Enter Customer ID:</label>
        <input type="text" name="customer_id" id="customer_id" required>
    </div>

    <h3>Select Products:</h3>
    <table id="product-table">
        <thead>
            <tr>
                <th>Product ID</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" name="product_ids" required onblur="getProductDetails(this)"></td>
                <td><span class="item-name"></span></td>
                <td><input type="number" name="quantities" min="1" required></td>
                <td><span class="price"></span></td>
            </tr>
        </tbody>
    </table>

    <button type="button" id="add-product">Add Another Product</button>
    <button type="submit">Generate Bill</button>
</form>

<script>
function getProductDetails(input) {
    const productId = input.value;

    // Make an AJAX request to fetch product details
    fetch('/get_product', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Set the item name and price in the respective span elements
            const row = input.parentElement.parentElement;
            row.querySelector('.item-name').innerText = data.product[1]; // Product Name
            row.querySelector('.price').innerText = data.product[2]; // Price
        } else {
            alert(data.message);
            input.value = ''; // Clear the input if product is not found
            const row = input.parentElement.parentElement;
            row.querySelector('.item-name').innerText = ''; // Clear item name
            row.querySelector('.price').innerText = ''; // Clear price
        }
    })
    .catch(error => console.error('Error fetching product details:', error));
}

document.getElementById('add-product').onclick = function() {
    // Create a new row
    const table = document.getElementById('product-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();

    // Create cells for Product ID, Item Name, Quantity, and Price
    const cell1 = newRow.insertCell(0);
    const cell2 = newRow.insertCell(1);
    const cell3 = newRow.insertCell(2);
    const cell4 = newRow.insertCell(3);

    // Add input field for Product ID and spans for Item Name and Price
    cell1.innerHTML = '<input type="text" name="product_ids" required onblur="getProductDetails(this)">';
    cell2.innerHTML = '<span class="item-name"></span>';
    cell3.innerHTML = '<input type="number" name="quantities" min="1" required>';
    cell4.innerHTML = '<span class="price"></span>';
};
</script>
{% endblock %}
